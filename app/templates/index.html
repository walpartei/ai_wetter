{% extends "base.html" %}

{% block title %}AI Wetter - Home{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const forecastForm = document.querySelector('form[action="/forecast"]');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    
    if (forecastForm) {
        forecastForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show the loading modal
            loadingModal.show();
            
            // Get form data
            const location = document.getElementById('location-select').value;
            const days = document.getElementById('days').value;
            
            // Set up source status tracking
            const availableSources = [{% for source in available_sources %}'{{ source }}',{% endfor %}];
            const sourceStatus = {};
            availableSources.forEach(source => sourceStatus[source] = 'pending');
            
            // Function to update UI for source status
            function updateSourceStatus(source, status) {
                const sourceElement = document.getElementById(`api-${source.toLowerCase()}`);
                const statusIcon = sourceElement.querySelector('.status-icon i');
                const progressBar = sourceElement.querySelector('.progress-bar');
                
                sourceStatus[source] = status;
                
                if (status === 'success') {
                    statusIcon.className = 'fas fa-check-circle text-success';
                    progressBar.className = 'progress-bar bg-success';
                } else if (status === 'error') {
                    statusIcon.className = 'fas fa-times-circle text-danger';
                    progressBar.className = 'progress-bar bg-danger';
                }
                
                // Check if all sources are done
                const allDone = Object.values(sourceStatus).every(s => s === 'success' || s === 'error');
                if (allDone) {
                    document.getElementById('loading-progress').innerHTML = 
                        '<small class="text-success">All data sources processed. Redirecting...</small>';
                    
                    // Redirect after a brief delay
                    setTimeout(function() {
                        window.location.href = `/forecast?location=${location}&days=${days}`;
                    }, 700);
                }
            }
            
            // Make API calls to check status for each source
            availableSources.forEach(source => {
                // Use fetch to call our API status endpoint
                fetch(`/api/forecast/status?location=${location}&source=${source}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSourceStatus(source, data.status);
                    })
                    .catch(error => {
                        console.error('Error checking source status:', error);
                        updateSourceStatus(source, 'error');
                    });
            });
            
            // Fallback: if nothing happens for 7 seconds, just redirect
            setTimeout(function() {
                window.location.href = `/forecast?location=${location}&days=${days}`;
            }, 7000);
        });
    }
});
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Bulgarian Weather Forecast Tool</h3>
            </div>
            <div class="card-body">
                <p class="lead">Get accurate weather forecasts for farming in Bulgaria from multiple sources.</p>
                
                <h4>Available Data Sources:</h4>
                <div class="mb-4">
                    {% for source in available_sources %}
                    <span class="source-badge source-{{ source.lower() }}">{{ source }}</span>
                    {% endfor %}
                </div>
                
                <form action="/forecast" method="get">
                    <div class="mb-3">
                        <label for="location-select" class="form-label">Select Location:</label>
                        {{ location_dropdown|safe }}
                    </div>
                    
                    <input type="hidden" id="days" name="days" value="14">
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">Get Forecast</button>
                    </div>
                </form>
                
                <hr>
                
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <a href="/history?location={{ default_location }}" class="btn btn-outline-secondary">View History</a>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <a href="/report/generate?location={{ default_location }}" class="btn btn-outline-success">Generate Report</a>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <a href="/report/list?location={{ default_location }}" class="btn btn-outline-info">Saved Reports</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Weather API Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="loadingModalLabel">Fetching Weather Data</h5>
            </div>
            <div class="modal-body">
                <p>Retrieving weather forecasts from multiple sources. This may take a few moments...</p>
                
                <div class="api-status-container">
                    {% for source in available_sources %}
                    <div class="d-flex align-items-center mb-3 api-status" id="api-{{ source.lower() }}">
                        <div class="source-badge source-{{ source.lower() }} me-2">{{ source }}</div>
                        <div class="flex-grow-1">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="ms-2 status-icon">
                            <i class="fas fa-circle-notch fa-spin text-info"></i>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="mt-3 text-center" id="loading-progress">
                    <small class="text-muted">Connecting to APIs...</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
